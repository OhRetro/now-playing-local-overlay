<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <title>"Now Playing" Local Overlay</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Jersey+10&display=swap");

    .hide {
      display: none !important;
    }

    #track {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      padding: 1rem;
      background-color: rgba(0, 0, 0, 0.75);
    }

    #track.visible {
      opacity: 1;
      transform: translateY(0);
    }

    #track.rightSide {
      flex-direction: row-reverse;
      position: absolute;
      right: 0;
      margin-right: 0.5rem;
    }

    #art {
      width: 6rem;
      height: 6rem;
      border-radius: 6px;
      border: 3px solid #000000;
    }

    #title {
      color: white;
      font-size: 3.5rem;
      font-weight: 400;
      text-shadow:
        -3px -3px 0 #000,
        3px -3px 0 #000,
        -3px 3px 0 #000,
        3px 3px 0 #000;
      padding-left: 3px;
    }

    #artist {
      color: gray;
      font-size: 2.25rem;
      font-weight: 200;
      text-shadow:
        -2px -2px 0 #000,
        2px -2px 0 #000,
        -2px 2px 0 #000,
        2px 2px 0 #000;
      padding-left: 3px;
    }

    #title,
    #artist {
      font-family: "Jersey 10", monospace;
      margin: 0;
    }

    #title-artist {
      display: flex;
      flex-direction: column;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #title-artist.inline {
      flex-direction: row;
      align-items: center;
      gap: 12px;
    }

    #track.rightSide>#title-artist {
      text-align: right;
      padding-left: 3px;
    }

    #track.rightSide>#title-artist.inline {
      flex-direction: row-reverse;
    }
  </style>
</head>

<body>
  <div id="track">
    <img id="art" />
    <div id="title-artist">
      <h1 id="title"></h1>
      <h2 id="artist"></h2>
    </div>
  </div>

  <script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);

    const noArt = urlParams.get("noArt") === "1";
    const rightSide = urlParams.get("rightSide") === "1";
    const inline = urlParams.get("inline") === "1";

    const trackElement = document.getElementById("track");
    const titleElement = document.getElementById("title");
    const artistElement = document.getElementById("artist");
    const titleArtistElement = document.getElementById("title-artist");
    const artElement = document.getElementById("art");

    if (noArt) artElement.classList.add("hide");
    if (rightSide) trackElement.classList.add("rightSide");
    if (inline) titleArtistElement.classList.add("inline");

    var lastId = "";
    var pendingTimeout = null;
    var overlayClient;

    function resetState(id) {
      trackElement.classList.remove("visible");
      lastId = id ?? "";

      if (pendingTimeout) {
        clearTimeout(pendingTimeout);
        pendingTimeout = null;
      }
    }

    function connectOverlayClient() {
      overlayClient = new WebSocket("ws://127.0.0.1:49210/overlayClient");

      overlayClient.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (!data || !data.playing) {
          resetState(null);
          return;
        }

        const id = `${data.title}-${data.artist}`;

        if (id !== lastId) {
          resetState(id);

          setTimeout(() => {
            titleElement.textContent = data.title;
            artistElement.textContent = data.artist;
            artElement.src = data.artwork;
            trackElement.classList.add("visible");
          }, 300);
        }
      };

      overlayClient.onclose = () => {
        resetState(null);

        pendingTimeout = setTimeout(connectOverlayClient, 1000);
      };
    }

    connectOverlayClient();

  </script>
</body>

</html>